" {{{ Init
" Remap the leader key to comma
let g:mapleader=','
let g:maplocalleader='\\'

if &compatible | set nocompatible | endif

augroup vimrc
    autocmd!
augroup END

" }}}
" {{{ Plugins
" {{{ Vim Plug
call plug#begin('~/.vim/bundle')

" tpope plugins, these deserve their own section
Plug 'tpope/vim-commentary'
Plug 'tpope/vim-repeat'
Plug 'tpope/vim-unimpaired'
Plug 'tpope/vim-dispatch'
Plug 'tpope/vim-surround'
Plug 'tpope/vim-rsi'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-git'
Plug 'tpope/vim-eunuch'

" Custom plugins
Plug 'kien/ctrlp.vim'
Plug 'rking/ag.vim'
Plug 'janko-m/vim-test'
Plug 'jgdavey/tslime.vim'
Plug 'christoomey/vim-tmux-navigator'
Plug 'christoomey/vim-tmux-runner'
Plug 'Wolfy87/vim-enmasse'
Plug 'kana/vim-textobj-user'
Plug 'bps/vim-textobj-python'
Plug 'MarcWeber/vim-addon-mw-utils'
Plug 'tomtom/tlib_vim'
Plug 'garbas/vim-snipmate'
Plug 'honza/vim-snippets'
Plug 'sjl/splice.vim'
Plug 'reedes/vim-pencil'
Plug 'altercation/vim-colors-solarized'
Plug 'airblade/vim-gitgutter'
Plug 'embear/vim-localvimrc'


" Languages
Plug 'vim-scripts/SWIG-syntax'
Plug 'chase/vim-ansible-yaml'
Plug 'mitsuhiko/vim-jinja'
Plug 'vim-scripts/TWiki-Syntax', { 'for': 'twiki' }
Plug 'mustache/vim-mustache-handlebars', { 'for': 'html.handlebars' }
Plug 'pangloss/vim-javascript'
Plug 'mxw/vim-jsx'
Plug 'zah/nimrod.vim', { 'for': 'nim' }
Plug 'elzr/vim-json'
Plug 'chase/vim-ansible-yaml'
Plug 'wlangstroth/vim-racket'
Plug 'rust-lang/rust.vim'

" My plugins
Plug 'mindriot101/vim-yapf'

call plug#end()
" }}}
" Plugin settings {{{
" {{{ matchit
runtime macros/matchit.vim
"}}}
" {{{ ctrlp
map <leader>f :CtrlP<cr>
map <leader>b :CtrlPBuffer<cr>
let g:ctrlp_map = "<leader>f"

" Always open file in new buffer
let g:ctrlp_switch_buffer = 0

" Use current working directory always
let g:ctrlp_working_path_mode = 0

" Open new files with <c-y> in same window
let g:ctrlp_open_new_file = 'r'

" Use silver searcher if available
if executable('ag')
    " Let ctrlp use ag for files
    let g:ctrlp_user_command = 'ag %s -i --nocolor --nogroup --hidden
                \ --ignore .git
                \ --ignore .svn
                \ --ignore .hg
                \ --ignore .DS_Store
                \ --ignore "**/*.pyc"
                \ -g ""'

    " Follow symlinks but not duplicates
    let g:ctrlp_follow_symlinks = 1

    " Change ctrlp style
    let g:ctrlp_match_window = 'bottom,order:btt'

    " Only remember a limited number of files
    let g:ctrlp_mruf_max = 0

    " Disable ag caching
    let g:ctrlp_use_caching = 0
endif

let g:ctrlp_custom_ignore = '\v\~$|\.(o|swp|pyc|wav|mp3|ogg|blend)$|(^|[/\\])\.(hg|git|bzr)($|[/\\])|venv/*'
"}}}
" {{{ vim-test
nnoremap <silent> <leader>ra :TestSuite<cr>
nnoremap <silent> <leader>rc :TestNearest<cr>
nnoremap <silent> <leader>rf :TestFile<cr>
nnoremap <silent> <leader>rl :TestLast<cr>

let g:test#python#runner = 'pytest'
let g:test#python#pytest#options = '--exitfirst'
"}}}
" {{{ fugitive
command! -bar -bang -nargs=* Gci :Gcommit<bang> -v <args>
nnoremap <leader>gd :Gdiff<cr>
nnoremap <leader>gc :Gci<cr>
nnoremap <leader>gw :Gwrite<cr>
nnoremap <leader>gr :Gread<cr>
nnoremap <leader>gs :Gstatus<cr>
nnoremap <leader>ga :Git amend<cr>
"}}}
" {{{ vim-yapf
" Mappings
autocmd vimrc FileType python map <buffer> <leader>y :Yapf --verify --style='{based_on_style: google, indent_width: 4, column_limit: 89}'<cr>
"}}}
" {{{ vim-commentary
let g:commentary_map_backslash = 0
"}}}
" {{{ vim-json
let g:vim_json_syntax_conceal = 0
"}}}
" {{{ snipmate
:imap <C-J> <Plug>snipMateNextOrTrigger
:smap <C-J> <Plug>snipMateNextOrTrigger
"}}}
" {{{ vim-tmux-runner
" Better python settings
let g:VtrStripLeadingWhitespace = 0
let g:VtrClearEmptyLines = 0
let g:VtrAppendNewline = 1
"}}}
" {{{ vim-pencil
let g:pencil#wrapModeDefault = 'soft'

autocmd vimrc FileType markdown,mkd call pencil#init()
autocmd vimrc FileType rst call pencil#init()
autocmd vimrc FileType text call pencil#init()
"}}}
" {{{ vim-localvimrc
"}}}
" Persist yes/no answers
let g:localvimrc_persistent=2
"}}}
" }}}
" {{{ Settings
""""""""""""""""""""
"     SETTINGS     "
""""""""""""""""""""

filetype plugin on

" turn syntax highlighting on
if (&t_Co > 2 || has("gui_running")) && !exists("syntax_on")
    syntax on
endif

" set up some nice tab defaults
set tabstop=4
set softtabstop=4
set shiftwidth=4
set shiftround
set expandtab
set smarttab
set shell=/bin/sh

" Necessary to show unicode glyphs
set encoding=utf-8
scriptencoding utf-8
set termencoding=utf-8
set fileencoding=utf-8

" Increase encryption protection
if v:version > 704
    set cryptmethod=blowfish2
endif

" Line numbering
set norelativenumber
set nonumber

" Use hlsearch
set hlsearch
nnoremap <space> :nohlsearch<cr>

" Do not use more prompt
set nomore

" Automatically save on certain commands
set autowrite

" Update shell
let g:is_posix = 1

" Shorten the paren matching flash time
set matchtime=3

" Set history settings
set history=250
set undolevels=100

" Do not jump to the start of line when indenting
set nostartofline

" reload all file changes automatically
set autoread

" set incremental search
set incsearch

" set case options for searching
set ignorecase
set smartcase

" Prevent Vim from clobbering the scrollback buffer. See
" http://www.shallowsky.com/linux/noaltscreen.html
set t_ti= t_te=

" From Steve Losh
" iTerm2 is currently slow as ball at rendering the nice unicode lines, so for now I'll just use ascii pipes.  They're ugly but at least I won't want to kill myself when trying to move around a file.
set fillchars=diff:⣿,vert:│
set fillchars=diff:⣿,vert:\|

" show command as it's typed
set showcmd

" nice file formatting
set autoindent
set smartindent
set cindent

" Always show the status bar
set laststatus=2

" make backspace behave nicely
set backspace=indent,eol,start

" Join lines with 1 space instead of 2
set nojoinspaces

" Disable all bells
set novisualbell
set noerrorbells
set t_vb=

" Set the tags file location
set tags=.git/tags,tags;/

" Tell us when anything is changed via :...
set report=0

" Enable fast tty mode
set ttyfast

" Enable folding
set foldenable

" Support file types in this order
set fileformats=unix,mac,dos

" Change the way tab autocompletion works
set wildmenu
set wildmode=longest,list:longest

" Disable escape keys which makes vim more responsive
set noesckeys

" Hide buffers instead of closing them
set hidden

" Don't update the display while executing macros
set lazyredraw

" Match parens when highlighting them
set showmatch

" Thesaurus
set thesaurus+=~/thesaurus/mthesaur.txt

" Handle the splat clipboard
if has('unnamedplus')
    set clipboard=unnamedplus
endif

" source local vimrc files
set exrc
set secure

" Enable british spelling
set spelllang=en_gb

" Better formatting
set formatprg=par

" Configure 'Press enter to continue' messages
set shortmess=atI

" Time out on key codes but not mappings
set notimeout
set ttimeout
set ttimeoutlen=1
set timeoutlen=500

set backup
set backupskip=/tmp/*,/private/tmp/*
set backupdir=~/.vim/tmp
set directory=~/.vim/tmp
set writebackup
set undofile
set undodir=~/.vim/tmp/undo

" Enable scrolljump
set scrolljump=10

" Disable conceal
set conceallevel=0

" Open new split panes at the bottom
set splitbelow
set splitright
set noequalalways

" Enable the ruler
set ruler

" Only show the tab line if multiple tabs
set showtabline=1

" Set some ignore patterns
set wildignore+=*.aux,*.o,*.git,/tmp/*,*.so,*.swp,*.zip,venv,env,*.pyc

set switchbuf=useopen

" Enable auto sourcing of vim config files
autocmd vimrc BufWritePost $MYVIMRC source $MYVIMRC
autocmd vimrc BufWritePost ~/dotfiles/vim/vimrc source ~/dotfiles/vim/vimrc

" Jump back to last file position
autocmd vimrc BufReadPost *
            \ if line("'\"") > 1 && line("'\"") <= line("$") |
            \ exe "normal! g`\"" |
            \ endif

" ... unless it's a git commit
autocmd vimrc FileType gitcommit autocmd! vimrc bufEnter COMMIT_EDITMSG call setpos('.', [0, 1, 1, 0])

" Highlight trailing whitespace only in normal mode
highlight ExtraWhitespace ctermbg=red guibg=red
autocmd vimrc InsertEnter * match ExtraWhitespace /\s\+\%#\@<!$/
autocmd vimrc InsertLeave * match ExtraWhitespace /\s\+$/

set scrolloff=1

" Nicer netrw style
let g:netrw_liststyle = 3

" Update current completion settings
" use spelling if 'spell'
set complete=.,w,b,u,t,i,kspell

" }}}
" {{{ Statusline

" Set up statusline
set statusline=

" Buffer number and pipe character with spaces
set statusline+=%-3.3n\ 

" Filename relative to opening path
set statusline+=%f\ 

" Status markers
set statusline+=%h%m%r%q

" End of left section, start right section
set statusline+=%=

" File type
set statusline+=%y\ 

" Cursor position
set statusline+=%-14.(%l,%c%V%)\ 

" View position
set statusline+=%P

" }}}
" {{{ Mappings
""""""""""""""""""""
"     MAPPINGS     "
""""""""""""""""""""

" Disable the 'help' key
nnoremap K <nop>

" Make line based movement more sane
nnoremap j gj
nnoremap k gk
nnoremap gj j
nnoremap gk k
vnoremap j gj
vnoremap k gk
vnoremap gj j
vnoremap gk k

" Multipurpose tab key from grb
function! InsertTabWrapper()
    let s:col = col('.') - 1
    if !s:col || getline('.')[s:col - 1] !~ '\k'
        return "\<tab>"
    else
        return "\<c-p>"
    endif
endfunction
inoremap <tab> <c-r>=InsertTabWrapper()<cr>
inoremap <s-tab> <c-n>

" delete comment character when joining commented lines
if v:version > 703 || v:version == 703 && has("patch541")
    set formatoptions+=j
endif

" settings from thoughtbot dotfiles repo
" Swap between two files
noremap gl <C-^>

" Speed up ctrl-e/ctrl-y
nnoremap <C-e> 3<C-e>
nnoremap <C-y> 3<C-y>

" Swap the mark keys
nnoremap ' `
nnoremap ` '

" Map control-s to update, rather than write
nnoremap <C-s> :update<CR>
inoremap <C-s> :update<CR>
vnoremap <C-s> :update<CR>

" Remap the Q key
noremap Q gqip

" Expand %% to the current directory
" http://vimcasts.org/e/14
cnoremap %% <c-r>=expand('%:h') . '/'<cr>

" Make the Y key work
noremap Y y$

" Reselect visual block after indent/outdent
vnoremap < <gv
vnoremap > >gv

" disable f1 key
inoremap <F1> <ESC>
nnoremap <F1> <ESC>
vnoremap <F1> <ESC>

" Remove the arrow key functionality
nnoremap <Up> :echo "Use k!"<cr>
nnoremap <Down> :echo "Use j!"<cr>
nnoremap <Left> :echo "Use h!"<cr>
nnoremap <Right> :echo "Use l!"<cr>
inoremap <Up> <esc>:echo "Use k!"<cr>
inoremap <Down> <esc>:echo "Use j!"<cr>
inoremap <Left> <esc>:echo "Use h!"<cr>
inoremap <Right> <esc>:echo "Use l!"<cr>

" Remap the move-window keys
noremap <C-h> <C-w>h
noremap <C-j> <C-w>j
noremap <C-k> <C-w>k
noremap <C-l> <C-w>l

" Handy saving of text if a C-u is pressed
inoremap <C-u> <C-g>u<C-u>
inoremap <C-w> <C-g>u<C-w>

" Quick file editing
nnoremap cv :tabe $MYVIMRC<cr>
nnoremap cz :tabe ~/.zshrc<cr>

" open Ag (note the space afterwards)
nnoremap <leader>a :Ag! -i --ignore "*tags" 

" Default leader mapping to run current file,
" with eunuch.vim this should basically work
" once a shebang is in place
noremap <leader>t :update\|!./%<cr>

" Map :W to :w
" http://stackoverflow.com/questions/3878692/aliasing-a-command-in-vim/3879737#3879737
cnoreabbrev <expr> W ((getcmdtype() is# ':' && getcmdline() is# 'W')?('w'):('W'))

" }}}
" {{{ Searching
" }}}
" {{{ Misc

""""""""""""""""""""
"       MISC       "
""""""""""""""""""""

" Set netrw style to 'long'
let g:netrw_liststyle=1

" Strip trailing whitespace
" http://stackoverflow.com/a/1618401/56711
fun! <SID>StripTrailingWhitespaces()
    let s:l = line(".")
    let s:c = col(".")
    %s/\s\+$//e
    call cursor(s:l, s:c)
endfun

autocmd vimrc Filetype c,cpp,ruby,python autocmd vimrc BufWritePre :call <SID>StripTrailingWhitespaces()

" Disable syntax highlighting when opening a large file
autocmd vimrc BufReadPre * if getfsize(expand("%")) > 10000000 | syntax clear | endif

" Diffs copy wrap from the global setting
autocmd vimrc FilterWritePre * if &diff | setlocal wrap< | endif

" }}}
" {{{ Theming
set background=dark
colorscheme srw256

" Make it more obvious which paren I'm on
hi MatchParen cterm=none ctermbg=black ctermfg=yellow

" Make git gutterline black background
hi SignColumn ctermbg=none
"}}}
" vim: foldmethod=marker
